version: 2

snapshots:
  - name: snap_customer
    description: |
      SCD2 snapshot of customer data tracking historical changes over time.
      
      This snapshot captures all changes to customer records, maintaining a complete
      history with validity timestamps. Each time a customer record changes, a new
      version is created with a new dbt_valid_from timestamp, and the previous
      version's dbt_valid_to is set to mark when it became inactive.
      
      Strategy: timestamp (using loaded_at column to detect changes)
      Unique Key: customer_id
      
      Use Cases:
      - Point-in-time analysis: Query customer state at any historical date
      - Change tracking: Identify when and how customer data changed
      - Audit trail: Maintain complete history for compliance
      - Trend analysis: Analyze customer attribute changes over time
    
    config:
      contract:
        enforced: true
    
    columns:
      - name: dbt_scd_id
        description: |
          Unique identifier for each record version, generated by DBT.
          This is a surrogate key that uniquely identifies each snapshot record,
          even when the same customer_id has multiple versions.
        data_type: string
        constraints:
          - type: not_null
          - type: unique
        tests:
          - unique
          - not_null
      
      - name: dbt_updated_at
        description: |
          Timestamp when this snapshot record was last updated by DBT.
          This reflects when the snapshot process last touched this record.
        data_type: timestamp
        constraints:
          - type: not_null
        tests:
          - not_null
      
      - name: dbt_valid_from
        description: |
          Timestamp when this version of the record became active.
          For the initial version, this is when the record was first snapshotted.
          For subsequent versions, this is when the change was detected.
          This column is used to filter for records valid at a specific point in time.
        data_type: timestamp
        constraints:
          - type: not_null
        tests:
          - not_null
      
      - name: dbt_valid_to
        description: |
          Timestamp when this version of the record became inactive.
          NULL indicates this is the current/active version of the record.
          Non-NULL indicates this is a historical version that has been superseded.
          Use "WHERE dbt_valid_to IS NULL" to get only current records.
        data_type: timestamp
      
      - name: customer_id
        description: |
          Unique identifier for the customer (business key).
          This is the natural key from the source system. Multiple snapshot records
          can have the same customer_id (representing different versions over time).
        data_type: integer
        constraints:
          - type: not_null
        tests:
          - not_null
      
      - name: customer_name
        description: |
          Customer's name, normalized to lowercase.
          Changes to this field will trigger creation of a new snapshot version.
        data_type: string
        constraints:
          - type: not_null
        tests:
          - not_null
      
      - name: has_loan_flag
        description: |
          Boolean indicator of whether the customer has an active loan.
          Standardized from various representations (yes/no, true/false, 1/0).
          Changes to this field will trigger creation of a new snapshot version.
        data_type: boolean
        constraints:
          - type: not_null
        tests:
          - not_null
      
      - name: loaded_at
        description: |
          Timestamp when the source data was loaded into the source layer.
          This is the timestamp used by the snapshot strategy to detect changes.
        data_type: timestamp
        constraints:
          - type: not_null
        tests:
          - not_null
    
    tests:
      - scd2_no_overlap:
          unique_key: customer_id
      - dbt_utils.recency:
          datepart: day
          field: dbt_valid_from
          interval: 7
          config:
            severity: warn

  - name: snap_account
    description: |
      SCD2 snapshot of account data tracking historical changes over time.
      
      This snapshot captures all changes to account records, including balance changes,
      account type changes, and customer reassignments. It maintains a complete history
      with validity timestamps for audit and analysis purposes.
      
      Strategy: check_cols (comparing all columns to detect any changes)
      Unique Key: account_id
      
      Use Cases:
      - Balance history: Track how account balances changed over time
      - Account type changes: Identify when accounts changed types
      - Point-in-time reporting: Generate reports as of any historical date
      - Audit trail: Maintain complete change history for compliance
      - Trend analysis: Analyze account growth and changes
    
    config:
      contract:
        enforced: true
    
    columns:
      - name: dbt_scd_id
        description: |
          Unique identifier for each record version, generated by DBT.
          This is a surrogate key that uniquely identifies each snapshot record,
          even when the same account_id has multiple versions.
        data_type: string
        constraints:
          - type: not_null
          - type: unique
        tests:
          - unique
          - not_null
      
      - name: dbt_updated_at
        description: |
          Timestamp when this snapshot record was last updated by DBT.
          This reflects when the snapshot process last touched this record.
        data_type: timestamp
        constraints:
          - type: not_null
        tests:
          - not_null
      
      - name: dbt_valid_from
        description: |
          Timestamp when this version of the record became active.
          For the initial version, this is when the record was first snapshotted.
          For subsequent versions, this is when the change was detected.
          This column is used to filter for records valid at a specific point in time.
        data_type: timestamp
        constraints:
          - type: not_null
        tests:
          - not_null
      
      - name: dbt_valid_to
        description: |
          Timestamp when this version of the record became inactive.
          NULL indicates this is the current/active version of the record.
          Non-NULL indicates this is a historical version that has been superseded.
          Use "WHERE dbt_valid_to IS NULL" to get only current records.
        data_type: timestamp
      
      - name: account_id
        description: |
          Unique identifier for the account (business key).
          This is the natural key from the source system. Multiple snapshot records
          can have the same account_id (representing different versions over time).
        data_type: string
        constraints:
          - type: not_null
        tests:
          - not_null
      
      - name: customer_id
        description: |
          Foreign key reference to the customer who owns this account.
          Changes to this field will trigger creation of a new snapshot version.
        data_type: integer
        constraints:
          - type: not_null
        tests:
          - not_null
      
      - name: balance_amount
        description: |
          Current balance of the account in decimal format with 2 decimal places.
          Changes to this field will trigger creation of a new snapshot version,
          allowing tracking of balance changes over time.
        data_type: decimal(18,2)
        constraints:
          - type: not_null
        tests:
          - not_null
      
      - name: account_type
        description: |
          Type of account (e.g., 'savings', 'checking'), normalized to lowercase.
          Changes to this field will trigger creation of a new snapshot version.
        data_type: string
        constraints:
          - type: not_null
        tests:
          - not_null
      
      - name: loaded_at
        description: |
          Timestamp when the source data was loaded into the source layer.
          This timestamp is preserved through the snapshot for reference.
        data_type: timestamp
        constraints:
          - type: not_null
        tests:
          - not_null
    
    tests:
      - scd2_no_overlap:
          unique_key: account_id
      - dbt_utils.recency:
          datepart: day
          field: dbt_valid_from
          interval: 7
          config:
            severity: warn
